{% extends "base.html" %} {% load static %} {% block title %} Measurement List -
FitLife {% endblock %} {% block content %}
<div class="container mt-5">
  <h1 class="mb-4">Measurements</h1>

  {% if user.is_authenticated %}
  <button
    class="btn btn-primary mb-3"
    data-bs-toggle="modal"
    data-bs-target="#measurementModal"
    onclick="openModal()"
  >
    Add Measurement
  </button>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Weight</th>
        <th>Height</th>
        <th>Chest</th>
        <th>Waist</th>
        <th>Hips</th>
        <th>Thighs</th>
        <th>Calves</th>
        <th>Left Arm</th>
        <th>Right Arm</th>
        <th>Unit</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="measurementTableBody">
      {% for measurement in measurements %}
      <tr id="measurement-{{ measurement.id }}">
        <td>{{ measurement.weight }}</td>
        <td>{{ measurement.height }}</td>
        <td>{{ measurement.chest }}</td>
        <td>{{ measurement.waist }}</td>
        <td>{{ measurement.hips }}</td>
        <td>{{ measurement.thighs }}</td>
        <td>{{ measurement.calves }}</td>
        <td>{{ measurement.left_arm }}</td>
        <td>{{ measurement.right_arm }}</td>
        <td>{{ measurement.unit }}</td>
        <td>
          <button
            class="btn btn-warning btn-edit"
            data-id="{{ measurement.id }}"
            onclick="editMeasurement({{ measurement.id }})"
          >
            Edit
          </button>
          <button
            class="btn btn-danger btn-delete"
            data-id="{{ measurement.id }}"
            onclick="deleteMeasurement({{ measurement.id }})"
          >
            Delete
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="alert alert-warning" role="alert">
    Please log in to start tracking your measurements.
    <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#loginModal"
    >
      Login
    </button>
  </div>
  {% endif %}
</div>

<!-- Measurement Modal -->
<div
  class="modal fade"
  id="measurementModal"
  tabindex="-1"
  aria-labelledby="measurementModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="measurementModalLabel">Add Measurement</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="measurementForm">
          <input type="hidden" name="id" id="measurementId" />
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="weight">Weight</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  name="weight"
                  id="weight"
                  required
                />
              </div>
              <div class="form-group">
                <label for="chest">Chest</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  name="chest"
                  id="chest"
                />
              </div>
              <div class="form-group">
                <label for="hips">Hips</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  name="hips"
                  id="hips"
                />
              </div>
              <div class="form-group">
                <label for="calves">Calves</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  name="calves"
                  id="calves"
                />
              </div>
              <div class="form-group">
                <label for="unit">Unit</label>
                <select class="form-control" name="unit" id="unit">
                  <option value="cm">Centimeters</option>
                  <option value="in">Inches</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="height">Height</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  name="height"
                  id="height"
                  required
                />
              </div>
              <div class="form-group">
                <label for="waist">Waist</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  name="waist"
                  id="waist"
                />
              </div>
              <div class="form-group">
                <label for="thighs">Thighs</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  name="thighs"
                  id="thighs"
                />
              </div>
              <div class="form-group">
                <label for="left_arm">Left Arm</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  name="left_arm"
                  id="left_arm"
                />
              </div>
              <div class="form-group">
                <label for="right_arm">Right Arm</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  name="right_arm"
                  id="right_arm"
                />
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="notes">Notes</label>
            <textarea class="form-control" name="notes" id="notes"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div
  class="modal fade"
  id="loginModal"
  tabindex="-1"
  aria-labelledby="loginModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Login Required</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p>Please log in to start tracking your measurements.</p>
        <a href="{% url 'userauth:login' %}" class="btn btn-primary"
          >Go to Login</a
        >
      </div>
    </div>
  </div>
</div>

<script>
  function openModal() {
    document.getElementById("measurementForm").reset();
    document.getElementById("measurementId").value = "";
    document.getElementById("measurementModalLabel").innerText =
      "Add Measurement";
  }

  function editMeasurement(id) {
    const row = document.getElementById(`measurement-${id}`);
    const cells = row.getElementsByTagName("td");

    document.getElementById("weight").value = cells[0].innerText;
    document.getElementById("height").value = cells[1].innerText;
    document.getElementById("chest").value = cells[2].innerText;
    document.getElementById("waist").value = cells[3].innerText;
    document.getElementById("hips").value = cells[4].innerText;
    document.getElementById("thighs").value = cells[5].innerText;
    document.getElementById("calves").value = cells[6].innerText;
    document.getElementById("left_arm").value = cells[7].innerText;
    document.getElementById("right_arm").value = cells[8].innerText;
    document.getElementById("unit").value = cells[9].innerText;
    document.getElementById("notes").value = cells[10].innerText;
    document.getElementById("measurementId").value = id;

    document.getElementById("measurementModalLabel").innerText =
      "Edit Measurement";
    const modal = new bootstrap.Modal(
      document.getElementById("measurementModal")
    );
    modal.show();
  }

  function deleteMeasurement(id) {
    if (confirm("Are you sure you want to delete this measurement?")) {
      fetch(`/measurements/${id}/delete/`, {
        method: "DELETE",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": "{{ csrf_token }}",
        },
      })
        .then((response) => {
          if (response.ok) {
            document.getElementById(`measurement-${id}`).remove();
          }
        })
        .catch((error) => console.error("Error:", error));
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("measurementForm");

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);
      for (const key in data) {
        if (data[key] === "") {
          data[key] = null; // Set empty fields to null or handle as needed
        } else {
          data[key] = data[key].trim(); // Trim whitespace
        }
      }

      const measurementId = data.id;
      const url = measurementId
        ? `/measurements/${measurementId}/edit/`
        : "/measurements/add/";

      fetch(url, {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            const tableBody = document.getElementById("measurementTableBody");
            if (measurementId) {
              // Update existing measurement
              const row = document.getElementById(
                `measurement-${measurementId}`
              );
              row.innerHTML = `
                <td>${data.measurement.weight}</td>
                <td>${data.measurement.height}</td>
                <td>${data.measurement.chest}</td>
                <td>${data.measurement.waist}</td>
                <td>${data.measurement.hips}</td>
                <td>${data.measurement.thighs}</td>
                <td>${data.measurement.calves}</td>
                <td>${data.measurement.left_arm}</td>
                <td>${data.measurement.right_arm}</td>
                <td>${data.measurement.unit}</td>
                <td>
                  <button class="btn btn-warning btn-edit" data-id="${data.measurement.id}" onclick="editMeasurement(${data.measurement.id})">Edit</button>
                  <button class="btn btn-danger btn-delete" data-id="${data.measurement.id}" onclick="deleteMeasurement(${data.measurement.id})">Delete</button>
                </td>`;
            } else {
              // Add new measurement
              const newRow = `<tr id="measurement-${data.measurement.id}">
                <td>${data.measurement.weight}</td>
                <td>${data.measurement.height}</td>
                <td>${data.measurement.chest}</td>
                <td>${data.measurement.waist}</td>
                <td>${data.measurement.hips}</td>
                <td>${data.measurement.thighs}</td>
                <td>${data.measurement.calves}</td>
                <td>${data.measurement.left_arm}</td>
                <td>${data.measurement.right_arm}</td>
                <td>${data.measurement.unit}</td>
                <td>
                  <button class="btn btn-warning btn-edit" data-id="${data.measurement.id}" onclick="editMeasurement(${data.measurement.id})">Edit</button>
                  <button class="btn btn-danger btn-delete" data-id="${data.measurement.id}" onclick="deleteMeasurement(${data.measurement.id})">Delete</button>
                </td>
              </tr>`;
              tableBody.innerHTML += newRow;
            }
            form.reset();
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("measurementModal")
            );
            modal.hide();
          }
        })
        .catch((error) => console.error("Error:", error));
    });
  });
</script>
{% endblock %}
